<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin - User Letters</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body { font-family: 'Inter', sans-serif; }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
    }
    
    .floating-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 text-gray-900 min-h-screen flex flex-col">
  
  <header class="sticky top-0 z-30 floating-header">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="admindashboard.html" class="w-8 h-8 rounded-lg gradient-bg flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="white" class="w-5 h-5">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" />
          </svg>
        </a>
        <div>
          <h1 class="text-xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent">User Letters</h1>
          <p class="text-xs text-gray-500 -mt-1">Inbox Management</p>
        </div>
      </div>
      <a href="admindashboard.html" class="px-4 py-2 text-sm rounded-xl btn-primary text-white flex items-center gap-2 font-medium">
         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
            <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
          </svg>
         Dashboard
      </a>
    </div>
  </header>

  <main class="flex-1 max-w-7xl mx-auto w-full px-6 py-8">
    
    <section class="mb-8 fade-in">
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Unread Messages</h2>
      
      <div id="lettersList" class="space-y-4">
        <div id="loadingMessage" class="glass-card p-6 rounded-2xl text-center text-gray-500">
            Loading letters...
        </div>
        <div id="emptyMessage" class="hidden glass-card p-6 rounded-2xl text-center text-gray-500">
            No user letters found. The inbox is empty!
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
    <div id="toastBody" class="px-6 py-4 rounded-2xl text-white shadow-2xl backdrop-blur-lg flex items-center gap-3 min-w-[280px] bg-gradient-to-r from-green-500 to-emerald-600">
      <div id="toastIcon" class="w-5 h-5 flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.236 4.53L8.53 10.53a.75.75 0 00-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
        </svg>
      </div>
      <span id="toastText" class="font-medium">Success!</span>
    </div>
  </div>

  <div id="modalContainer" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
    <div class="glass-card rounded-3xl max-w-md w-full mx-4 p-8 space-y-6 shadow-2xl transition-all duration-300 transform scale-95 opacity-0">
      <div class="text-center">
        <div id="modalIcon" class="w-16 h-16 mx-auto rounded-2xl gradient-bg flex items-center justify-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="white" class="w-8 h-8">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8.94 6.94a.75.75 0 11-1.061-1.061 3 3 0 112.871 5.026v.345a.75.75 0 01-1.5 0v-.5c0-.72.57-1.172 1.081-1.287A1.5 1.5 0 108.94 6.94zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
          </svg>
        </div>
        <h3 id="modalTitle" class="text-xl font-bold text-gray-900"></h3>
        <p id="modalMessage" class="text-gray-600 mt-2"></p>
      </div>
      <div class="flex flex-col gap-3 pt-4 border-t border-gray-100">
        <button id="modalConfirmBtn" class="w-full px-6 py-3 btn-danger text-white rounded-2xl font-medium">
          Confirm Delete
        </button>
        <button id="modalCancelBtn" class="w-full px-6 py-3 border-2 border-gray-200 text-gray-700 rounded-2xl hover:bg-gray-50 font-medium transition-all duration-200">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // **NOTE: You must use the exact same config as your other files**
    const firebaseConfig = {
      apiKey: "AIzaSyDZUVChTTWtGm4R40wMWGrTYwyUk0FDahs",
      authDomain: "sklepaga-8790e.firebaseapp.com",
      projectId: "sklepaga-8790e",
      storageBucket: "sklepaga-8790e.appspot.com",
      messagingSenderId: "815409129057",
      appId: "1:815409129057:web:9f6342be47e28c1f69ec20",
      measurementId: "G-9GH707G2WZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI Elements
    const lettersListEl = document.getElementById("lettersList");
    const loadingMessage = document.getElementById("loadingMessage");
    const emptyMessage = document.getElementById("emptyMessage");
    const toastEl = document.getElementById("toast");
    const toastBody = document.getElementById("toastBody");
    const toastIcon = document.getElementById("toastIcon");
    const toastText = document.getElementById("toastText");
    const modalContainer = document.getElementById("modalContainer");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
    const modalCancelBtn = document.getElementById("modalCancelBtn");
    const modalConfirmBtn = document.getElementById("modalConfirmBtn");
    
    let activeAdmin = null;

    // --- Utility Functions ---

    function toast(msg, type = "success") {
      const icons = {
        success: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.236 4.53L8.53 10.53a.75.75 0 00-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>`,
        error: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 001.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>`
      };
      
      const colors = {
        success: "bg-gradient-to-r from-green-500 to-emerald-600",
        error: "bg-gradient-to-r from-red-500 to-rose-600"
      };
      
      toastBody.className = `px-6 py-4 rounded-2xl text-white shadow-2xl backdrop-blur-lg flex items-center gap-3 min-w-[280px] ${colors[type]}`;
      toastIcon.innerHTML = icons[type];
      toastText.textContent = msg;
      toastEl.classList.remove("hidden");
      setTimeout(() => toastEl.classList.add("hidden"), 3000);
    }

    function showModal(title, message) {
      return new Promise(resolve => {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        
        // Show the modal with transition
        modalContainer.classList.remove("hidden");
        setTimeout(() => {
          modalContainer.querySelector("div").classList.remove("scale-95", "opacity-0");
          modalContainer.querySelector("div").classList.add("scale-100", "opacity-100");
        }, 10);

        const cleanUp = () => {
          modalContainer.querySelector("div").classList.add("scale-95", "opacity-0");
          modalContainer.querySelector("div").classList.remove("scale-100", "opacity-100");
          setTimeout(() => modalContainer.classList.add("hidden"), 300);
          
          modalConfirmBtn.onclick = null;
          modalCancelBtn.onclick = null;
        };

        modalConfirmBtn.onclick = () => { cleanUp(); resolve(true); };
        modalCancelBtn.onclick = () => { cleanUp(); resolve(false); };
      });
    }

    function formatDate(timestamp) {
      if (!timestamp || typeof timestamp.toDate !== 'function') return 'â€”';
      return timestamp.toDate().toLocaleString();
    }

    // --- Core Functions ---

    /**
     * Renders the list of letters to the UI.
     * @param {Array} letters - Array of letter documents from Firestore.
     */
    function renderLetters(letters) {
      lettersListEl.innerHTML = '';
      loadingMessage.classList.add('hidden');
      
      if (letters.length === 0) {
        emptyMessage.classList.remove('hidden');
        return;
      } else {
        emptyMessage.classList.add('hidden');
      }

      letters.forEach((letter, index) => {
        const card = document.createElement("div");
        card.className = "glass-card p-6 rounded-2xl flex flex-col fade-in";
        card.style.animationDelay = `${index * 0.05}s`;
        
        card.innerHTML = `
          <div class="flex items-start justify-between mb-4">
            <div class="flex flex-col">
              <h3 class="text-lg font-bold text-gray-900">${letter.name || 'Anonymous'}</h3>
              <p class="text-sm text-blue-600 font-medium break-all mt-1">${letter.email || 'No email provided'}</p>
            </div>
            <span class="text-xs text-gray-500 flex-shrink-0 ml-4">${formatDate(letter.timestamp)}</span>
          </div>
          
          <p class="text-gray-700 whitespace-pre-wrap flex-1 min-h-[60px] max-h-40 overflow-auto border-y border-gray-100 py-4 mb-4">${letter.message || '(Empty message)'}</p>
          
          <div class="flex justify-end gap-3 pt-2">
            <a href="mailto:${letter.email}?subject=RE: Your message to SK Lepaga&body=Dear ${letter.name || 'User'}," 
               class="replyBtn px-4 py-2 text-sm rounded-xl btn-primary text-white font-medium flex items-center gap-2">
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path d="M10 2a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 2zM3.25 10a.75.75 0 000 1.5h13.5a.75.75 0 000-1.5H3.25zM10 17.25a.75.75 0 01-.75-.75v-3.5a.75.75 0 011.5 0v3.5a.75.75 0 01-.75.75z" />
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-5.657-2.176l1.325-1.325a.75.75 0 011.061 0l2.5 2.5a.75.75 0 010 1.06l-2.5 2.5a.75.75 0 01-1.06 0l-1.326-1.324z" clip-rule="evenodd" />
                </svg>
               Reply
            </a>
            <button class="deleteBtn px-4 py-2 text-sm rounded-xl btn-danger text-white font-medium flex items-center gap-2" data-doc-id="${letter.id}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.5H2.75a.75.75 0 000 1.5h14.5a.75.75 0 000-1.5H14V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 5.25a.75.75 0 00-.75.75v5.5a.75.75 0 001.5 0v-5.5a.75.75 0 00-.75-.75z" clip-rule="evenodd"/>
                <path d="M3 8.75a.75.75 0 01.75-.75h12.5a.75.75 0 01.75.75v8.5a.75.75 0 01-.75.75H3.75a.75.75 0 01-.75-.75v-8.5z"/>
              </svg>
              Delete
            </button>
          </div>
        `;
        
        card.querySelector(".deleteBtn").addEventListener("click", () => handleDelete(letter.id));
        
        lettersListEl.appendChild(card);
      });
    }

    /**
     * Handles the deletion of a letter.
     * @param {string} docId - The Firestore document ID of the letter.
     */
    async function handleDelete(docId) {
      const ok = await showModal("Confirm Deletion", "Are you sure you want to permanently delete this user letter? This action cannot be undone.");
      if (!ok) return;

      try {
        await deleteDoc(doc(db, "letters", docId));
        toast("Letter deleted successfully!");
      } catch (e) {
        console.error("Error deleting document: ", e);
        toast("Failed to delete letter.", "error");
      }
    }

    /**
     * Initializes the letters listener.
     */
    function initializeLettersListener() {
      // Create a query to get all documents from the 'letters' collection, ordered by timestamp descending (newest first)
      const lettersQuery = query(collection(db, "letters"), orderBy("timestamp", "desc"));
      
      // onSnapshot sets up a real-time listener
      onSnapshot(lettersQuery, (snapshot) => {
        const letters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderLetters(letters);
      }, (error) => {
        console.error("Error getting letters:", error);
        loadingMessage.textContent = "Error loading messages. Check console.";
      });
    }

    // --- Authentication Check ---

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not authenticated, redirect to login
        window.location.href = "google.html"; 
        return;
      }

      // Check for Admin Role (using the same logic as your dashboard)
      try {
        const adminDoc = await getDoc(doc(db, "admin", user.uid));
        if (adminDoc.exists()) { 
          activeAdmin = user;
          initializeLettersListener(); // Start listening for letters once admin is confirmed
        } else {
          // Authenticated but not an admin
          alert("You are not authorized to view the admin letters page.");
          await signOut(auth);
          window.location.href = "google.html";
        }
      } catch (e) {
        console.error("Admin check failed:", e);
        alert("An error occurred during authorization check.");
        await signOut(auth);
        window.location.href = "google.html";
      }
    });

    // Helper function used in admin dashboard to check admin status
    // Note: getDoc is not imported by default in this scope, so we import it explicitly
    import { getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  </script>
</body>
</html>
