<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">Loading Article...</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.gstatic.com/s/inter/v12/1Pn0EnyXJmdSgbTxHLk.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fontfaceobserver/2.1.0/fontfaceobserver.standalone.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="navbar/navbar.css">
  <link rel="stylesheet" href="font/font.css">
  <link rel="stylesheet" href="animations/global.css">
  <link rel="stylesheet" href="pages/index.css">
  <link rel="stylesheet" href="controlers/scroll.css">
  <link rel="stylesheet" href="sections/hero.css">
  <link rel="stylesheet" href="sections/carousel.css">

  <style>
    body.preload {
      visibility: hidden;
      opacity: 0;
    }

    body {
      transition: opacity 0.2s ease-in;
    }

    #article-content-wrapper {
      padding-top: 3rem;
    }
  </style>
</head>

<body class="preload">
  <main id="swup" class="transition-fade">
    <div class="main-content text-container" id="article-content-wrapper">

      <!-- Navbar -->
      <nav id="navbar" class="duration-300 fixed inset-x-0 top-0 z-50 h-12 w-full">
        <div class="w-full h-full bg-white dark:bg-[#242424] px-3">
          <div class="flex items-center justify-between h-full max-w-screen-xl mx-auto">
            <a href="index.html" class="flex items-center space-x-2" data-transition rel="nofollow noopener">
              <img src="https://sklepagatesting.github.io/resources/Images/sklogo.webp" alt="Logo" class="h-5 w-auto" />
              <span class="font-theme font-medium">SK Lepaga</span>
            </a>
            <button id="menu-toggle-btn" type="button"
              class="font-theme rounded-md hover:bg-[#e8e8e8] dark:hover:bg-[#696969] focus:outline-none">
              <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path id="menu-icon-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>
      </nav>

      <!-- Article Section -->
      <section class="font-theme px-4 py-8 sm:py-16 bg-white dark:bg-[#242424]">
        <div class="max-w-screen-xl mx-auto px-4 pb-6 sm:pb-8 pt-10 sm:pt-24">

          <div id="loading-or-error" class="hidden text-center py-20">
            <p class="text-xl text-gray-700 dark:text-gray-300">Loading article...</p>
          </div>

          <div id="article-main" class="hidden">
            <div class="text-container">
              <h2 id="article-category" class="rise subtext text-gray-400 mt-4 uppercase"></h2>
            </div>

            <div class="text-container">
              <h2 id="article-title" class="text-line subtext-title font-theme mt-6 sm:mt-8 mb-6 sm:mb-8"></h2>
            </div>

            <div class="max-w-screen-xl mx-auto">
              <div class="zoom parallax flex flex-col mx-auto overflow-hidden relative z-10 image-parallax-sizing"
                data-dark-border="#242424">
                <img id="article-image" src="" alt="Article Featured Image" class="w-full h-auto object-cover">
              </div>
            </div>

            <div class="container max-w-5xl py-6 sm:py-12">
              <div class="grid gap-2 sm:grid-cols-2 text-left">
                <div>
                  <div class="text-left mt-4 mb-10 sm:mb-14 before:block before:w-24 before:h-3 before:mb-5 before:rounded-full before:bg-violet-600 dark:before:bg-violet-400">
                    <h3 class="rise context font-medium text-gray-700 dark:text-gray-300">
                      Published: <span id="article-date" class="font-bold"></span><br>
                      By: <span id="article-author" class="font-bold"></span><br>
                      Category: <span id="article-category-meta" class="font-bold"></span><br>
                      <span class="text-xs text-gray-400">Slug: <span id="article-slug"></span></span>
                    </h3>
                  </div>
                </div>

                <div class="relative px-4 space-y-6">
                  <div class="space-y-10 sm:space-y-8 relative px-4 sm:before:absolute sm:before:top-2 sm:before:bottom-0 sm:before:w-0.5 sm:before:-left-3 before:bg-gray-300 dark:before:bg-gray-700">
                    <div class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-4 sm:before:h-4 sm:before:rounded-full sm:before:left-[-35px] sm:before:z-[1] before:bg-violet-600 dark:before:bg-violet-400">
                      <h3 class="rise subtext font-bold">Article Context</h3>
                      <p id="article-context" class="left-in-slow context dark:text-gray-400 whitespace-pre-wrap"></p>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- Footer -->
      <footer class="footer relative bg-white dark:bg-[#242424] text-gray-700 dark:text-gray-300 antialiased pt-12 pb-6 border-t border-gray-100 dark:border-gray-800">
        <div class="footer-tint absolute inset-0 pointer-events-none opacity-0 transition-opacity duration-500"></div>
        <div class="relative z-10 max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col items-center">
          <div class="text-sm space-y-2 text-center">
            <p class="context text-gray-600 dark:text-gray-400 font-medium">Developed by <strong>Your Company Name</strong></p>
            <p class="context text-gray-500 dark:text-gray-500">&copy; <strong id="current-year">2024</strong> All Rights Reserved.</p>
          </div>
        </div>
      </footer>
    </div>
  </main>

  <style>
    .footer-tint {
      background: linear-gradient(to top, var(--tint-color, transparent) 70%, transparent 100%);
    }
  </style>

  <!-- Firebase + Article Loader -->
  <script>
    const FIREBASE_PROJECT_ID = 'sklepaga-8790e';
    const JSON_URL = `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}/databases/(default)/documents/contentJson/data`; 

    const articleMain = document.getElementById('article-main');
    const loadingOrError = document.getElementById('loading-or-error');

    const extractValue = (field) => {
      if (!field) return null;
      if (field.stringValue) return field.stringValue;
      if (field.integerValue) return parseInt(field.integerValue);
      return null;
    };

    // âœ… Slug detection (query or path)
    function getSlugFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const querySlug = urlParams.get("slug");
      if (querySlug) return querySlug;

      const path = window.location.pathname;
      const match = path.match(/\/article\/([^\/]+)\.html$/); 
      if (match && match[1]) return match[1];

      const segments = path.split('/').filter(s => s.length > 0);
      if (segments.length >= 2 && segments[segments.length - 2] === 'article') {
        return segments[segments.length - 1];
      }
      return null; 
    }

    async function loadArticle() {
      const slug = getSlugFromUrl();
      if (!slug) {
        loadingOrError.innerHTML = '<p class="text-xl text-red-500">Error: Article slug not found in URL.</p>';
        loadingOrError.classList.remove('hidden');
        return;
      }

      loadingOrError.classList.remove('hidden');
      articleMain.classList.add('hidden');

      try {
        const response = await fetch(`${JSON_URL}?t=${Date.now()}`, { cache: "no-cache" });
        if (!response.ok) throw new Error(`HTTP status ${response.status}`);

        const data = await response.json();
        const rawContentValues = data.fields?.content?.arrayValue?.values || [];
        
        let articleData = null;

        for (const item of rawContentValues) {
          const fields = item.mapValue?.fields;
          if (!fields) continue;

          const itemSlug = extractValue(fields.slug);
          if (itemSlug === slug) {
            articleData = {
              title: extractValue(fields.title),
              slug: itemSlug,
              datePublished: extractValue(fields.datePublished),
              context: extractValue(fields.context),
              image: extractValue(fields.image),
              category: extractValue(fields.category),
              author: extractValue(fields.author),
            };
            break;
          }
        }

        if (!articleData) {
          loadingOrError.innerHTML = `<p class="text-xl text-red-500">Article with slug "${slug}" not found.</p>`;
          return;
        }

        // Render
        document.getElementById('page-title').textContent = articleData.title;
        document.getElementById('article-category').textContent = articleData.category;
        document.getElementById('article-category-meta').textContent = articleData.category;
        document.getElementById('article-title').textContent = articleData.title;
        document.getElementById('article-image').src = articleData.image;
        document.getElementById('article-image').alt = articleData.title;
        document.getElementById('article-date').textContent = new Date(articleData.datePublished).toLocaleDateString();
        document.getElementById('article-author').textContent = articleData.author;
        document.getElementById('article-slug').textContent = articleData.slug;
        document.getElementById('article-context').textContent = articleData.context;

        loadingOrError.classList.add('hidden');
        articleMain.classList.remove('hidden');

      } catch (error) {
        console.error("Failed to load article:", error);
        loadingOrError.innerHTML = `<p class="text-xl text-red-500">Failed to load content: ${error.message}</p>`;
      }
    }

    window.addEventListener("DOMContentLoaded", loadArticle);
  </script>

  <!-- Preload fix -->
  <script>
    // Remove preload after fonts or fallback
    const inter = new FontFaceObserver('Inter');
    Promise.race([
      inter.load(null, 3000),
      new Promise(res => setTimeout(res, 2000))
    ]).finally(() => {
      document.body.classList.remove('preload');
    });
  </script>

  <!-- GSAP + Tailwind + Swup -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
  <script src="https://unpkg.com/swup@latest/dist/swup.min.js"></script>
</body>
</html>
