<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Upload Panel</title>
  <script type="module">
    // ----------------- IMPORT FIREBASE -----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      getDocs, 
      addDoc, 
      setDoc, 
      collection 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ----------------- CONFIG -----------------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ----------------- DOM ELEMENTS -----------------
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const statusBox = document.getElementById("status");
    const uploadForm = document.getElementById("uploadForm");
    const titleInput = document.getElementById("title");
    const contextInput = document.getElementById("context");
    const imageInput = document.getElementById("image");
    const authorInput = document.getElementById("author");

    let currentUser = null;
    let isAdmin = false;

    // ----------------- LOGIN -----------------
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        statusBox.textContent = `❌ Login failed: ${err.message}`;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ----------------- AUTH STATE -----------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        statusBox.textContent = `Signed in as ${user.email} (UID: ${user.uid})... checking admin...`;

        // check admin doc
        const adminDoc = await getDoc(doc(db, "admin", user.uid));
        if (adminDoc.exists()) {
          isAdmin = true;
          statusBox.textContent = `✅ Admin confirmed: ${user.email}`;
          uploadForm.style.display = "block";
          loginBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
          authorInput.value = user.displayName || user.email;
        } else {
          isAdmin = false;
          statusBox.textContent = `❌ Not an admin (${user.email})`;
          uploadForm.style.display = "none";
          loginBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
        }
      } else {
        currentUser = null;
        isAdmin = false;
        statusBox.textContent = "Not signed in.";
        uploadForm.style.display = "none";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    });

    // ----------------- UPLOAD HANDLER -----------------
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!isAdmin || !currentUser) {
        alert("❌ You are not authorized.");
        return;
      }

      const newContent = {
        title: titleInput.value.trim(),
        context: contextInput.value.trim(),
        image: imageInput.value.trim(),
        author: currentUser.displayName || currentUser.email,
        authorId: currentUser.uid,
        date: new Date().toISOString(),
        timestamp: Date.now()
      };

      try {
        // 1. Add to /content collection
        await addDoc(collection(db, "content"), newContent);

        // 2. Fetch all content
        const snapshot = await getDocs(collection(db, "content"));
        const allContent = [];
        snapshot.forEach(docSnap => {
          allContent.push({ id: docSnap.id, ...docSnap.data() });
        });

        // 3. Update /contentJson/data
        await setDoc(doc(db, "contentJson", "data"), {
          updatedAt: new Date().toISOString(),
          content: allContent
        });

        alert("✅ Content published successfully!");
        uploadForm.reset();
        authorInput.value = currentUser.displayName || currentUser.email;
      } catch (err) {
        console.error("Upload failed:", err);
        alert(`❌ Upload failed: ${err.message}`);
      }
    });
  </script>
</head>
<body style="font-family: sans-serif; max-width: 700px; margin: 2rem auto;">
  <h1>Admin Upload Panel</h1>
  <p id="status">Checking auth...</p>
  <button id="loginBtn">🔑 Sign in with Google</button>
  <button id="logoutBtn" style="display:none;">🚪 Sign out</button>

  <form id="uploadForm" style="display:none; margin-top: 1.5rem;">
    <h2>📤 Publish Content</h2>
    <label>Title:<br>
      <input type="text" id="title" required style="width:100%; padding:8px; margin:4px 0;">
    </label><br>
    <label>Context:<br>
      <textarea id="context" rows="5" required style="width:100%; padding:8px; margin:4px 0;"></textarea>
    </label><br>
    <label>Image URL:<br>
      <input type="url" id="image" required style="width:100%; padding:8px; margin:4px 0;">
    </label><br>
    <label>Author:<br>
      <input type="text" id="author" readonly style="width:100%; padding:8px; margin:4px 0; background:#f0f0f0;">
    </label><br>
    <button type="submit" style="margin-top:10px; padding:10px 20px;">Publish</button>
  </form>
</body>
</html>
